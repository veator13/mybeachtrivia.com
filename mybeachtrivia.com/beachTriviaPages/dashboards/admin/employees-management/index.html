<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="color-scheme" content="light dark" />
  <title>Employees Admin</title>

  <!-- Page styles -->
  <link rel="stylesheet" href="style.css"/>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-functions-compat.js"></script>

  <!-- Your Firebase config + initialize -->
  <script src="/firebase-init.js"></script>

  <!-- Auth guard (keeps page hidden until authorized) -->
  <script src="./auth-guard.js" defer></script>
</head>

<body data-page="employees-admin">
  <!-- Authentication Loading Overlay -->
  <div id="auth-loading" class="auth-overlay" aria-live="polite">
    <div class="spinner" role="status" aria-label="Loading"></div>
    <p>Verifying access...</p>
  </div>

  <div class="container" style="display:none;">
    <header class="page-header">
      <div>
        <h1 class="page-title">Employees Management</h1>
        <p class="page-subtitle">Provision new accounts and manage existing employees.</p>
      </div>
    </header>

    <!-- ===== Provision Employee (admin creates Auth user + sends password setup link) ===== -->
    <section class="card card-provision" id="provision-card" aria-labelledby="provision-title">
      <div class="card-head">
        <h2 id="provision-title" class="card-title">Create Employee &amp; Send Password Setup Link</h2>
      </div>

      <div class="card-body">
        <div class="provision-grid">
          <div class="field">
            <label for="email-input" class="label">Email</label>
            <input id="email-input" type="email" class="input" placeholder="person@example.com" required>
          </div>

          <fieldset id="roles-fieldset" class="roles-fieldset field">
            <legend class="label">Assign roles</legend>
            <label class="check"><input type="checkbox" name="roles" value="host" checked> Host</label>
            <label class="check"><input type="checkbox" name="roles" value="admin"> Admin</label>
            <label class="check"><input type="checkbox" name="roles" value="regional"> Regional manager</label>
            <label class="check"><input type="checkbox" name="roles" value="supply"> Supply manager</label>
            <label class="check"><input type="checkbox" name="roles" value="writer"> Writer</label>
            <label class="check"><input type="checkbox" name="roles" value="social"> Social media manager</label>
          </fieldset>

          <div class="actions">
            <button id="provision-btn" class="btn btn-primary">
              Create Employee
            </button>
          </div>
        </div>

        <!-- Status + where provision.js can inject "Open link" and "Copy link" -->
        <div id="provision-status" class="muted" aria-live="polite"></div>
        <div id="provision-actions" class="form-actions" style="justify-content:flex-start; margin-top:10px;"></div>

        <details class="help">
          <summary>What this does</summary>
          <div>
            Creates the Auth user (if not already present), writes
            <code>employees/{uid}</code> with <code>{ email, role, active: true }</code>,
            and generates a secure password-reset link (first-time password setup).
            We’ll also copy the link to your clipboard.
          </div>
        </details>
      </div>
    </section>
    <!-- ===== /Provision Employee ===== -->

    <!-- Employee Edit Modal -->
    <div id="employeeModal" class="modal" aria-hidden="true" aria-labelledby="employeeModalTitle" role="dialog">
      <div class="modal-content">
        <button type="button" class="close-modal" aria-label="Close">&times;</button>
        <form id="employeeForm" novalidate>
          <h3 id="employeeModalTitle" class="modal-title">Edit Employee</h3>
          <input type="hidden" id="employeeId">

          <div class="form-grid">
            <div class="form-group">
              <label for="firstName" class="label">First Name</label>
              <input type="text" id="firstName" class="input" required>
            </div>

            <div class="form-group">
              <label for="lastName" class="label">Last Name</label>
              <input type="text" id="lastName" class="input" required>
            </div>

            <div class="form-group">
              <label for="email" class="label">Email</label>
              <input type="email" id="email" class="input" required>
            </div>

            <div class="form-group">
              <label for="phone" class="label">Phone</label>
              <input type="tel" id="phone" class="input">
            </div>

            <div class="form-group">
              <label for="nickname" class="label">Nickname</label>
              <input type="text" id="nickname" class="input">
            </div>

            <div class="form-group">
              <label for="employeeID" class="label">Employee ID</label>
              <input type="text" id="employeeID" class="input">
            </div>

            <div class="form-group">
              <label for="emergencyContactName" class="label">Emergency Contact Name</label>
              <input type="text" id="emergencyContactName" class="input">
            </div>

            <div class="form-group">
              <label for="emergencyContactPhone" class="label">Emergency Contact Phone</label>
              <input type="tel" id="emergencyContactPhone" class="input">
            </div>

            <div class="form-group">
              <label for="active" class="label">Active</label>
              <select id="active" class="input">
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" id="saveEmployee" class="btn btn-primary">Save Employee</button>
            <button type="button" id="cancelEdit" class="btn btn-ghost">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Employees Table -->
    <section class="card card-table">
      <div class="card-head" style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px;">
        <div>
          <h2 class="card-title" style="margin-bottom:2px;">Employees</h2>
          <div class="muted" id="employees-count" aria-live="polite"></div>
        </div>

        <!-- Search Employees -->
        <div class="field table-search" style="min-width:min(420px, 100%); max-width:520px;">
          <label for="employeeSearch" class="label">Search employees</label>
          <input
            id="employeeSearch"
            type="text"
            class="input"
            placeholder="Search name, email, phone, ID…"
            autocomplete="off"
            aria-label="Search employees"
          />
          <div class="muted" id="employeeSearchHint" style="margin-top:-2px;">Type to filter the table.</div>
        </div>
      </div>

      <div class="card-body">
        <div id="employees-no-results" class="muted" style="display:none; margin: 0 0 10px 0;" aria-live="polite"></div>

        <div class="table-wrapper">
          <table id="employeesTable" class="table">
            <thead>
              <tr>
                <th scope="col" class="sticky-col col-fname">First</th>
                <th scope="col" class="sticky-col col-lname">Last</th>

                <!-- Scrollable info columns -->
                <th scope="col" class="col-email">Email</th>
                <th scope="col" class="col-phone">Phone</th>
                <th scope="col" class="col-nickname">Nickname</th>
                <th scope="col" class="col-employee-id">Employee ID</th>
                <th scope="col" class="col-emergency-name">Emergency Contact</th>
                <th scope="col" class="col-emergency-phone">Emergency Phone</th>
                <th scope="col">Roles</th>

                <!-- Frozen right side -->
                <th scope="col" class="sticky-col col-active">Active</th>
                <th scope="col" class="sticky-col col-actions">Actions</th>
              </tr>
            </thead>
            <tbody id="employeesTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Boot (reveals container when auth OK) -->
  <script src="boot.js"></script>

  <!-- Page logic -->
  <script src="./script.js" defer></script>

  <!-- New provision flow (calls callable function) -->
  <script src="./provision.js" defer></script>

  <!-- Inline-only overlay styles (kept here intentionally) -->
  <style>
    .auth-overlay {
      position: fixed; inset: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 1000; color: #fff;
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 4px solid #3699ff;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>

  <!-- Route guard (prod) -->
  <script src="/beachTriviaPages/js/auth-route-guard.v2.js?v=2025-10-14a"></script>
</body>
</html>